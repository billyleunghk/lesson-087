---
name: Build and Push Python Image to GCP
on:
    push:
        branches: [ main ]

env:
    IMAGE_NAME: lesson-087
    PROJECT_ID: eks-202411-441114
    GAR_LOCATION: us-west2-docker.pkg.dev/eks-202411-441114/images/
    GIT_TAB: v0.1.0
    WORKING_DIR: billyleunghk
    DOCKER_LOC: lesson-087
jobs:
    build-push-gcr:
        name: Build and Push to GCP
        runs-on: ubuntu-latest
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags')  # <-- Notice that I'm filtering here to only run when a tagged commit is pushed        
        
        permissions:
            contents: 'read'
            id-token: 'write'

        steps:
        - name: Checkout
          uses: actions/checkout@v3

        - id: 'auth'
          uses: 'google-github-actions/auth@v2'
          with:
            credentials_json: '${{ secrets.SERVICE_ACCOUNT_KEY }}'

        - name: Configure Docker Auth
          run: |
            gcloud auth configure-docker us-west2-docker.pkg.dev  --quiet
        
        - name: Build Docker Image
          run: docker build -t ${{ env.IMAGE_NAME }}:latest .

        - name: Get tag
          id: get-tag
          run: echo ::set-output name=short_ref::${GITHUB_REF#refs/*/}

        - id: docker-push-tagged
          name: Tag Docker image and push to Google Artifact Registry
          uses: docker/build-push-action@v2
          with:
            push: true
            tags: |
               ${{ env.GAR_LOCATION }}/${{ env.IMAGE_NAME }}:${{ steps.get-tag.outputs.short_ref }}
               ${{ env.GAR_LOCATION }}/${{ env.IMAGE_NAME }}:latest